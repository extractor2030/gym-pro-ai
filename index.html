<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Pro Trainer + AI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #1f2937);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            padding-top: 16px;
            padding-left: 16px;
            padding-right: 16px;
        }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .btn-ai {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
        }
        .timer-active {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* –¢–∞–±–±–∞—Ä */
        .tab-item {
            transition: all 0.2s;
            opacity: 0.5;
            transform: scale(1);
        }
        .tab-item.active {
            opacity: 1;
            color: var(--tg-theme-button-color, #2481cc);
            transform: scale(1.1);
        }
        .hidden-view { display: none !important; }
        
        .program-item {
            border-left: 3px solid transparent;
        }
        .program-item.completed {
            border-left-color: #22c55e;
            opacity: 0.6;
        }
        .safe-area-bottom { z-index: 50; }
        .full-screen-modal { z-index: 100; }
        .fab-btn { box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            height: 100px;
            gap: 8px;
            padding-top: 20px;
        }
        .chart-bar {
            flex: 1;
            background-color: #3b82f6;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.5s ease;
            min-height: 4px;
        }
        .chart-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #1f2937;
            white-space: nowrap;
        }
        .chart-date {
            text-align: center;
            font-size: 8px;
            margin-top: 4px;
            opacity: 0.5;
        }
        
        .search-item:active { background-color: #f3f4f6; }

        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .accordion-content.open {
            max-height: 500px;
            opacity: 1;
        }

        .ai-suggestion-card {
            background: linear-gradient(to right, #f5f3ff, #ffffff);
            border: 1px solid #ddd6fe;
        }
    </style>
</head>
<body class="select-none">

    <!-- –í–∫–ª–∞–¥–∫–∞ 1: –ü–†–û–§–ò–õ–¨ -->
    <div id="tab-profile" class="">
        <h1 class="text-2xl font-bold mb-2">–ü—Ä–æ—Ñ–∏–ª—å –∞—Ç–ª–µ—Ç–∞</h1>
        <div class="card p-5 shadow-sm space-y-5 relative overflow-hidden mb-4">
             <div class="flex items-center gap-4 mb-2">
                <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center text-2xl font-bold text-gray-400">
                    <span id="avatar-initial">?</span>
                </div>
                <div class="flex-1">
                    <label class="block text-[10px] font-bold opacity-50 mb-1 uppercase">–ò–º—è</label>
                    <input type="text" id="profile-name" placeholder="–¢–≤–æ–µ –∏–º—è" oninput="syncProfileData()"
                           class="w-full bg-transparent border-b border-gray-200 py-1 text-lg font-bold focus:border-blue-500 outline-none transition-colors">
                </div>
            </div>
            <div>
                <label class="block text-[10px] font-bold opacity-50 mb-2 uppercase">–ü–æ–ª</label>
                <div class="flex bg-gray-100 rounded-xl p-1 gap-1">
                    <button id="gender-male" onclick="selectGender('male')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all gender-btn-inactive bg-white text-blue-600 shadow-sm">–ú—É–∂—Å–∫–æ–π</button>
                    <button id="gender-female" onclick="selectGender('female')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all text-gray-400">–ñ–µ–Ω—Å–∫–∏–π</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-[10px] font-bold opacity-50 mb-1 uppercase">–í–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" id="profile-age" placeholder="25" oninput="syncProfileData()" class="w-full bg-gray-50 rounded-xl p-3 text-center font-bold outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                </div>
                <div>
                    <label class="block text-[10px] font-bold opacity-50 mb-1 uppercase">–†–æ—Å—Ç (—Å–º)</label>
                    <input type="number" id="profile-height" placeholder="180" oninput="syncProfileData(); calculateBMI();" class="w-full bg-gray-50 rounded-xl p-3 text-center font-bold outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                </div>
            </div>
            <hr class="border-gray-100">
            <div>
                <label class="block text-[10px] font-bold text-blue-600 mb-1 uppercase">–¢–µ–∫—É—â–∏–π –≤–µ—Å (–∫–≥)</label>
                <div class="flex gap-2">
                    <input type="number" id="profile-weight" placeholder="80.0" step="0.1" class="w-full bg-blue-50 text-blue-900 rounded-xl p-4 text-center text-2xl font-black outline-none focus:ring-2 focus:ring-blue-300">
                </div>
                <div class="flex justify-between items-center mt-2 px-2">
                    <span class="text-xs font-bold opacity-50 uppercase">–ò–ú–¢: <span id="bmi-display">--.--</span></span>
                    <button onclick="saveCurrentWeight()" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-2 rounded-lg active:scale-95 transition-transform">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å</button>
                </div>
            </div>
            <button id="btn-save-profile" onclick="handleProfileButton()" class="btn-primary w-full py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform mt-2 shadow-lg shadow-blue-500/30">–ù–ê–ß–ê–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£</button>
        </div>
        <button onclick="toggleWeightChart()" class="w-full bg-white border border-gray-200 p-3 rounded-xl flex items-center justify-center gap-2 mb-4 text-sm font-bold text-gray-600 active:scale-95 transition-all">
            <i data-lucide="bar-chart-2" class="w-4 h-4"></i> –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞ <i data-lucide="chevron-down" id="chart-arrow" class="w-4 h-4 transition-transform"></i>
        </button>
        <div id="weight-progress-section" class="accordion-content card px-4 pb-4 mb-6">
            <div id="weight-chart" class="chart-bar-container"></div>
            <div id="weight-chart-dates" class="flex justify-between px-1"></div>
        </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ 2: –¢–†–ï–ù–ò–†–û–í–ö–ê -->
    <div id="tab-workout" class="hidden-view">
        <div class="flex justify-between items-center mb-4">
            <div><h1 class="text-xl font-bold">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h1><p id="current-date" class="text-xs opacity-60"></p></div>
        </div>

        <!-- VIEW 1: –°–ï–õ–ï–ö–¢–û–† –ü–†–û–ì–†–ê–ú–ú–´ -->
        <div id="view-selector" class="animate-in fade-in duration-300">
            <h2 class="text-lg font-bold mb-3">–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è?</h2>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="setWorkoutType('strength')" id="type-strength" class="card p-4 flex flex-col items-center gap-2 border-2 border-transparent active:scale-95 transition-all"><span class="text-3xl">üèãÔ∏è‚Äç‚ôÇÔ∏è</span><span class="font-bold text-sm">–°–∏–ª–æ–≤–∞—è</span></button>
                <button onclick="setWorkoutType('cardio')" id="type-cardio" class="card p-4 flex flex-col items-center gap-2 border-2 border-transparent active:scale-95 transition-all"><span class="text-3xl">üèÉ</span><span class="font-bold text-sm">–ö–∞—Ä–¥–∏–æ</span></button>
            </div>
            <div id="focus-area-strength" class="hidden">
                <h3 class="text-sm font-bold opacity-50 mb-3 uppercase">–ó–æ–Ω–∞ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="generateAIProgram('–°–ø–∏–Ω–∞')" class="category-btn bg-white p-3 rounded-xl font-bold text-sm shadow-sm">–°–ø–∏–Ω–∞</button>
                    <button onclick="generateAIProgram('–ì—Ä—É–¥—å')" class="category-btn bg-white p-3 rounded-xl font-bold text-sm shadow-sm">–ì—Ä—É–¥—å</button>
                    <button onclick="generateAIProgram('–ù–æ–≥–∏')" class="category-btn bg-white p-3 rounded-xl font-bold text-sm shadow-sm">–ù–æ–≥–∏</button>
                    <button onclick="generateAIProgram('–†—É–∫–∏')" class="category-btn bg-white p-3 rounded-xl font-bold text-sm shadow-sm">–†—É–∫–∏</button>
                    <button onclick="generateAIProgram('–ü–ª–µ—á–∏')" class="category-btn bg-white p-3 rounded-xl font-bold text-sm shadow-sm">–ü–ª–µ—á–∏</button>
                    <button onclick="generateAIProgram('Full Body')" class="category-btn bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-3 rounded-xl font-bold text-sm shadow-md col-span-2">üî• Full Body</button>
                </div>
            </div>
            <div id="focus-area-cardio" class="hidden">
                <h3 class="text-sm font-bold opacity-50 mb-3 uppercase">–¢–∏–ø –Ω–∞–≥—Ä—É–∑–∫–∏</h3>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="generateAIProgram('HIIT')" class="category-btn bg-white p-4 rounded-xl font-bold text-sm shadow-sm flex justify-between items-center"><span>üî• HIIT (–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–∞—è)</span><span class="text-xs opacity-50">~20 –º–∏–Ω</span></button>
                    <button onclick="generateAIProgram('LISS')" class="category-btn bg-white p-4 rounded-xl font-bold text-sm shadow-sm flex justify-between items-center"><span>üö∂ LISS (–ù–∏–∑–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å)</span><span class="text-xs opacity-50">~40-60 –º–∏–Ω</span></button>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200">
                <button onclick="startCustomWorkout()" class="w-full bg-white border-2 border-gray-200 text-gray-500 p-4 rounded-xl font-bold text-sm flex items-center justify-center gap-2 active:scale-95 transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i>–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
            </div>
        </div>

        <!-- VIEW 2: –°–ü–ò–°–û–ö –£–ü–†–ê–ñ–ù–ï–ù–ò–ô (–ü–†–ï–í–¨–Æ/–ü–õ–ê–ù) -->
        <div id="view-plan" class="hidden-view animate-in slide-in-from-right duration-300 relative min-h-screen flex flex-col">
            <div class="flex items-center gap-2 mb-4">
                <button onclick="backToSelector()" class="bg-gray-200 p-2 rounded-lg text-xs font-bold">‚Üê –ú–µ–Ω—é</button>
                <div class="flex-1"><h2 id="plan-title" class="text-lg font-bold leading-tight">–ü—Ä–æ–≥—Ä–∞–º–º–∞</h2><p class="text-xs opacity-50">–ü–æ–¥–≥–æ—Ç–æ–≤—å —Å–ø–∏—Å–æ–∫ –∏ –∂–º–∏ —Å—Ç–∞—Ä—Ç</p></div>
            </div>
            
            <div id="program-list" class="space-y-3 pb-36 flex-1 overflow-y-auto">
                <!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
            </div>

            <!-- FAB: –î–æ–±–∞–≤–∏—Ç—å -->
             <div class="fixed bottom-28 right-4 z-50">
                <button onclick="openAddExerciseModal()" class="fab-btn bg-white text-blue-600 w-12 h-12 rounded-full flex items-center justify-center active:scale-90 transition-transform shadow-md border border-blue-100">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>
             </div>
        </div>

        <!-- VIEW 3: –ê–ö–¢–ò–í–ù–ê–Ø –¢–†–ï–ù–ò–†–û–í–ö–ê -->
        <div id="view-active-workout" class="hidden-view full-screen-modal animate-in slide-in-from-bottom duration-300 bg-gray-50 fixed inset-0 flex flex-col">
            <div class="bg-white p-4 shadow-sm flex justify-between items-center">
                <button onclick="closeActiveMode()" class="bg-gray-100 rounded-full p-2"><i data-lucide="chevron-down" class="w-6 h-6 text-gray-600"></i></button>
                <div class="text-center"><h3 class="font-bold text-sm text-gray-500 uppercase tracking-wide">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3><div id="active-progress" class="text-xs font-bold text-blue-600">1 –∏–∑ 6</div></div>
                <button onclick="skipCurrentExercise()" class="text-xs font-bold text-gray-400 bg-gray-100 px-3 py-1.5 rounded-lg">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pb-24 flex flex-col">
                <div class="card p-6 shadow-md mb-4 bg-white flex-1 flex flex-col justify-center min-h-[300px]">
                    <div class="flex justify-between items-start">
                        <h2 id="active-ex-name" class="text-2xl font-black text-center mb-2 leading-tight flex-1">–ñ–∏–º –ª–µ–∂–∞</h2>
                        <button onclick="getAiProTip()" class="bg-purple-100 text-purple-600 p-2 rounded-full active:scale-90 transition-transform"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
                    </div>
                    <p id="active-ex-tip" class="text-sm text-center text-gray-500 mb-6 bg-gray-50 p-2 rounded-lg italic min-h-[3rem] flex items-center justify-center">–°–ª–µ–¥–∏ –∑–∞ —Ç–µ—Ö–Ω–∏–∫–æ–π</p>
                    <div class="flex justify-center gap-1 mb-6" id="sets-dots"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold opacity-50 mb-1 uppercase text-center">–í–µ—Å (–∫–≥)</label><input type="number" id="active-weight" step="0.5" class="w-full bg-blue-50 border-2 border-blue-100 rounded-2xl p-4 text-center text-3xl font-black focus:border-blue-500 outline-none transition-colors"></div>
                        <div><label class="block text-xs font-bold opacity-50 mb-1 uppercase text-center">–ü–æ–≤—Ç–æ—Ä—ã</label><input type="number" id="active-reps" class="w-full bg-blue-50 border-2 border-blue-100 rounded-2xl p-4 text-center text-3xl font-black focus:border-blue-500 outline-none transition-colors"></div>
                    </div>
                </div>
                <div id="active-actions" class="grid grid-cols-1 gap-3">
                    <button onclick="logActiveSet()" class="btn-primary w-full py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform shadow-lg flex items-center justify-center gap-2"><i data-lucide="check" class="w-6 h-6"></i>–ó–ê–ü–ò–°–ê–¢–¨ –ü–û–î–•–û–î</button>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–ö–ê –û–¢–î–´–•–ê -->
        <div id="modal-rest" class="hidden-view full-screen-modal bg-black/90 backdrop-blur-md fixed inset-0 flex flex-col items-center justify-center z-[80] p-6 text-white animate-in fade-in duration-200">
            <div class="text-center mb-8"><h3 class="text-sm font-bold opacity-50 uppercase tracking-widest mb-2">–û—Ç–¥—ã—Ö</h3><div id="rest-timer-big" class="text-7xl font-black font-mono">01:30</div></div>
            <div class="w-full max-w-xs bg-gray-800 rounded-2xl p-4 mb-8"><div class="text-xs text-gray-400 uppercase mb-1">–î–∞–ª–µ–µ:</div><div id="rest-next-step" class="font-bold text-lg">–ü–æ–¥—Ö–æ–¥ 2</div><div id="rest-next-ex" class="text-sm text-gray-500 truncate">–ñ–∏–º –ª–µ–∂–∞</div></div>
            <button onclick="skipRest()" class="bg-white text-black px-8 py-4 rounded-full font-bold text-lg active:scale-95 transition-transform">–Ø –ì–û–¢–û–í! ‚ö°</button>
        </div>

        <!-- –ú–û–î–ê–õ–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø -->
        <div id="modal-add-exercise" class="hidden-view full-screen-modal bg-black/50 backdrop-blur-sm fixed inset-0 flex items-end z-[90]">
            <div class="bg-white w-full rounded-t-2xl p-6 h-[85vh] flex flex-col animate-in slide-in-from-bottom duration-300">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg" id="modal-add-title">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3><button onclick="closeAddExerciseModal()" class="bg-gray-100 rounded-full p-2"><i data-lucide="x" class="w-4 h-4"></i></button></div>
                <button id="btn-ask-ai" onclick="triggerAiSuggestions()" class="hidden w-full mb-4 bg-gradient-to-r from-purple-100 to-indigo-100 border border-purple-200 p-3 rounded-xl flex items-center justify-center gap-2 text-purple-700 font-bold text-sm active:scale-95 transition-transform"><i data-lucide="sparkles" class="w-4 h-4"></i>–ü–æ–¥–æ–±—Ä–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã —Å –ò–ò</button>
                <div id="ai-suggestions-container" class="hidden mb-4 p-3 bg-purple-50 rounded-xl border border-purple-100 flex-shrink-0 max-h-[40vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-2"><div class="flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4 text-purple-600"></i><span class="text-xs font-bold text-purple-700 uppercase">–°–æ–≤–µ—Ç—ã —Ç—Ä–µ–Ω–µ—Ä–∞</span></div><button onclick="hideAiSuggestions()" class="text-purple-400"><i data-lucide="x-circle" class="w-4 h-4"></i></button></div>
                    <div id="ai-suggestions-list" class="space-y-2"></div>
                </div>
                <div class="flex bg-gray-100 rounded-xl p-1 gap-1 mb-4 shrink-0"><button id="tab-add-strength" onclick="setAddTab('strength')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm">–°–∏–ª–æ–≤–∞—è</button><button id="tab-add-cardio" onclick="setAddTab('cardio')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-gray-400">–ö–∞—Ä–¥–∏–æ</button></div>
                <div class="relative mb-4 shrink-0"><i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i><input type="text" id="search-exercise" placeholder="–ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è..." oninput="filterExercises()" class="w-full bg-gray-50 pl-10 pr-4 py-3 rounded-xl font-bold outline-none border border-gray-100 focus:border-blue-400"></div>
                <div id="exercise-search-results" class="flex-1 overflow-y-auto space-y-1 mb-4 pr-1"></div>
                <div class="pt-4 border-t border-gray-100 shrink-0">
                    <div id="manual-inputs" class="grid grid-cols-2 gap-2 mb-2 hidden"><input type="number" id="manual-sets" placeholder="–ü–æ–¥—Ö–æ–¥—ã" value="3" class="bg-gray-50 p-2 rounded-lg text-center text-sm font-bold"><input type="text" id="manual-reps" placeholder="–ü–æ–≤—Ç–æ—Ä—ã" value="12" class="bg-gray-50 p-2 rounded-lg text-center text-sm font-bold"></div>
                    <button id="btn-add-manual" onclick="addExerciseFromInput()" class="btn-primary w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i><span id="btn-add-text">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–µ</span></button>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–ö–ê –ò–ù–§–û -->
        <div id="modal-info" class="hidden-view full-screen-modal bg-black/50 backdrop-blur-sm fixed inset-0 flex items-center justify-center z-[100] p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 animate-in zoom-in-95 duration-200 shadow-2xl">
                <div class="flex justify-between items-start mb-4"><h3 id="info-title" class="font-bold text-lg pr-4">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3><button onclick="closeInfoModal()" class="bg-gray-100 rounded-full p-2 shrink-0"><i data-lucide="x" class="w-4 h-4"></i></button></div>
                <div class="bg-blue-50 p-4 rounded-xl text-sm text-blue-900 leading-relaxed max-h-[60vh] overflow-y-auto"><p id="info-description" class="whitespace-pre-line">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
                <button onclick="closeInfoModal()" class="w-full mt-4 bg-gray-100 py-3 rounded-xl font-bold text-sm">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>

        <!-- –ò–¢–û–ì–ò –¢–†–ï–ù–ò–†–û–í–ö–ò -->
        <div id="modal-workout-summary" class="hidden-view full-screen-modal bg-white fixed inset-0 flex flex-col z-[110] animate-in slide-in-from-bottom duration-300">
            <div class="p-6 bg-gradient-to-b from-purple-600 to-indigo-700 text-white rounded-b-3xl shadow-xl mb-4"><h2 class="text-3xl font-black mb-1">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2><p class="opacity-80 text-sm">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –∞—Ç–ª–µ—Ç üí™</p></div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="bg-purple-50 p-5 rounded-2xl border border-purple-100 relative overflow-hidden">
                    <div class="absolute -top-2 -right-2 w-16 h-16 bg-purple-200 rounded-full blur-2xl"></div>
                    <div class="flex items-center gap-2 mb-3"><i data-lucide="sparkles" class="w-5 h-5 text-purple-600"></i><h3 class="font-bold text-purple-900 uppercase text-xs tracking-wider">–ê–Ω–∞–ª–∏–∑ & –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h3></div>
                    <div id="summary-ai-content" class="text-sm text-purple-800 leading-relaxed space-y-2"><div class="flex items-center gap-2"><div class="loader border-purple-300 border-t-purple-600"></div><span class="animate-pulse">–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É...</span></div></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-50 p-4 rounded-2xl text-center"><div id="summary-total-exercises" class="text-2xl font-black text-gray-800">0</div><div class="text-xs text-gray-400 font-bold uppercase">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div></div>
                    <div class="bg-gray-50 p-4 rounded-2xl text-center"><div id="summary-total-sets" class="text-2xl font-black text-gray-800">0</div><div class="text-xs text-gray-400 font-bold uppercase">–ü–æ–¥—Ö–æ–¥–æ–≤</div></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100"><button onclick="closeSummaryAndSave()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é</button></div>
        </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ 3: –ò–°–¢–û–†–ò–Ø -->
    <div id="tab-history" class="hidden-view">
        <h1 class="text-2xl font-bold mb-2">–ò—Å—Ç–æ—Ä–∏—è</h1>
        <p class="text-sm opacity-60 mb-6">–¢–≤–æ–π –ø—É—Ç—å –∫ —É—Å–ø–µ—Ö—É</p>
        <div class="mb-6"><button onclick="analyzeHistory()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-purple-200 active:scale-95 transition-transform"><i data-lucide="brain-circuit" class="w-5 h-5"></i>AI –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button></div>
        <div id="history-ai-result" class="hidden mb-6 p-4 bg-purple-50 rounded-xl border border-purple-100 animate-in fade-in">
            <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-purple-800 text-sm flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> –í–µ—Ä–¥–∏–∫—Ç —Ç—Ä–µ–Ω–µ—Ä–∞</h3><button onclick="closeHistoryAi()" class="text-purple-400"><i data-lucide="x" class="w-4 h-4"></i></button></div>
            <p id="history-ai-text" class="text-sm text-purple-900 leading-relaxed whitespace-pre-line"></p>
        </div>
        <div id="history-list" class="space-y-3 pb-24"><div class="text-center py-10 opacity-40 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
    </div>

    <!-- –î–ï–¢–ê–õ–ò –ò–°–¢–û–†–ò–ò -->
    <div id="modal-history-detail" class="hidden-view full-screen-modal bg-gray-50 fixed inset-0 flex flex-col z-[60] animate-in slide-in-from-right duration-300">
        <div class="bg-white p-4 shadow-sm flex items-center gap-3"><button onclick="closeHistoryDetail()" class="bg-gray-100 p-2 rounded-lg"><i data-lucide="arrow-left" class="w-5 h-5"></i></button><div><h3 id="hist-detail-title" class="font-bold text-lg leading-tight">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3><p id="hist-detail-date" class="text-xs opacity-50">–î–∞—Ç–∞</p></div></div>
        <div id="hist-detail-content" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
    </div>

    <!-- –¢–∞–±–±–∞—Ä -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around py-3 pb-6 safe-area-bottom shadow-lg z-40">
        <button onclick="switchTab('profile')" id="nav-profile" class="tab-item flex flex-col items-center gap-1 active"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px] font-bold">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        <button onclick="switchTab('workout')" id="nav-workout" class="tab-item flex flex-col items-center gap-1"><i data-lucide="dumbbell" class="w-6 h-6"></i><span class="text-[10px] font-bold">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span></button>
        <button onclick="switchTab('history')" id="nav-history" class="tab-item flex flex-col items-center gap-1"><i data-lucide="calendar-clock" class="w-6 h-6"></i><span class="text-[10px] font-bold">–ò—Å—Ç–æ—Ä–∏—è</span></button>
    </div>

    <div id="ai-loading" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] backdrop-blur-sm"><div class="bg-white p-6 rounded-2xl flex flex-col items-center gap-4 shadow-2xl w-64 text-center"><div class="loader"></div><p id="loading-text" class="text-sm font-bold text-gray-700 animate-pulse">–ò–ò —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞–Ω...</p></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-YFhTWpHYvAZzLkmskSckZyqNnfc4280",
            authDomain: "gym-pro-db.firebaseapp.com",
            projectId: "gym-pro-db",
            storageBucket: "gym-pro-db.firebasestorage.app",
            messagingSenderId: "746009678402",
            appId: "1:746009678402:web:77f25bac12ca872fd913db",
            measurementId: "G-KCYY36PMRD"
        };

        let app, db, analytics;
        try {
            app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);
            db = getFirestore(app);
        } catch(e) {
            console.error("Firebase init failed", e);
        }

        const tg = window.Telegram.WebApp;
        const apiKey = "AIzaSyB8TMVo4mP31EEJrvJ-lFXaWSWz3iWfms0"; 
        tg.expand();
        lucide.createIcons();

        const EXERCISE_DB = {
            strength: ["–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞", "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞", "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ø–æ–¥ —É–≥–ª–æ–º", "–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –≥–∞–Ω—Ç–µ–ª–µ–π", "–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞", "–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å–æ —à—Ç–∞–Ω–≥–æ–π", "–ñ–∏–º –Ω–æ–≥–∞–º–∏", "–í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏", "–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ", "–°–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", "–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞", "–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", "–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞", "–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", "–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ –æ–¥–Ω–æ–π —Ä—É–∫–æ–π", "–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è", "–ê—Ä–º–µ–π—Å–∫–∏–π –∂–∏–º", "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è", "–ú–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª—è–º–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã", "–ü—Ä–æ—Ç—è–∂–∫–∞ —Å–æ —à—Ç–∞–Ω–≥–æ–π", "–ü–æ–¥—ä–µ–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –±–∏—Ü–µ–ø—Å", "–ú–æ–ª–æ—Ç–∫–∏ —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏", "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º", "–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–µ", "–ü–ª–∞–Ω–∫–∞", "–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è"],
            cardio: ["–ë–µ–≥ –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ", "–≠–ª–ª–∏–ø—Å–æ–∏–¥", "–í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂–µ—Ä", "–ì—Ä–µ–±–Ω–æ–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä", "–°–∫–∞–∫–∞–ª–∫–∞", "–ë–µ—Ä–ø–∏", "–î–∂–∞–º–ø–∏–Ω–≥ –î–∂–µ–∫", "–°—Ç–µ–ø–ø–µ—Ä"]
        };

        let userProfile = { name: "", gender: "male", age: "", height: "", weight: "", weightHistory: [], workoutHistory: [], isLocked: false };
        let currentProgram = [];
        let currentWorkoutTitle = "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
        let currentExerciseIndex = -1;
        let replacementIndex = null;
        let workoutLogs = {};
        let addModalType = 'strength';
        let isWorkoutActive = false;

        async function saveToFirestore() {
            if (!db) return;
            const userId = tg.initDataUnsafe?.user?.id || localStorage.getItem('gym_local_id') || 'guest';
            try {
                await setDoc(doc(db, "users", String(userId)), userProfile, { merge: true });
            } catch(e) { console.error("Cloud save failed", e); }
        }

        let saveTimeout;
        function persistData() { 
            localStorage.setItem('gymProProfile', JSON.stringify(userProfile)); 
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToFirestore, 2000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
            
            // 1. Get User Info
            const user = tg.initDataUnsafe?.user;
            if (user) {
                userProfile.name = user.first_name || "–ê—Ç–ª–µ—Ç";
            } else {
                if(!localStorage.getItem('gym_local_id')) localStorage.setItem('gym_local_id', 'user_' + Date.now());
            }

            // 2. Load Local
            const savedProfile = localStorage.getItem('gymProProfile');
            if(savedProfile) {
                try {
                    const parsed = JSON.parse(savedProfile);
                    userProfile = { ...userProfile, ...parsed };
                    applyProfileUI();
                } catch(e) {}
            }

            // 3. Load Cloud
            if (db) {
                const userId = tg.initDataUnsafe?.user?.id || localStorage.getItem('gym_local_id') || 'guest';
                try {
                    const docSnap = await getDoc(doc(db, "users", String(userId)));
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        userProfile = { ...userProfile, ...cloudData };
                        applyProfileUI();
                        persistData(); // Sync back to local
                    }
                } catch(e) { console.error("Cloud load failed", e); }
            }

            renderHistoryList();
        });

        function applyProfileUI() {
            if(userProfile.isLocked) {
                ['profile-name', 'profile-age', 'profile-height'].forEach(id => { const el = document.getElementById(id); if(el) { el.disabled = true; el.classList.add('opacity-50'); }});
                document.getElementById('btn-save-profile').innerText = "–ö –¢–†–ï–ù–ò–†–û–í–ö–ï";
            }
            document.getElementById('profile-name').value = userProfile.name;
            document.getElementById('profile-age').value = userProfile.age;
            document.getElementById('profile-height').value = userProfile.height;
            document.getElementById('profile-weight').value = userProfile.weight;
            updateAvatarInitial(userProfile.name);
            selectGender(userProfile.gender);
            calculateBMI();
        }

        // Expose functions to window because type="module" isolates scope
        window.updateAvatarInitial = function(name) { document.getElementById('avatar-initial').innerText = name ? name[0].toUpperCase() : "?"; }
        window.syncProfileData = function() { if(userProfile.isLocked) return; userProfile.name = document.getElementById('profile-name').value; userProfile.age = document.getElementById('profile-age').value; userProfile.height = document.getElementById('profile-height').value; userProfile.weight = parseFloat(document.getElementById('profile-weight').value) || ""; updateAvatarInitial(userProfile.name); persistData(); }
        window.saveCurrentWeight = function() { const w = parseFloat(document.getElementById('profile-weight').value); if (!w) return; const dateStr = new Date().toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'}); userProfile.weightHistory.push({ weight: w, date: dateStr }); if(userProfile.weightHistory.length > 7) userProfile.weightHistory.shift(); persistData(); tg.HapticFeedback.notificationOccurred('success'); renderWeightChart(); alert(`–í–µ—Å ${w} –∫–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`); }
        window.toggleWeightChart = function() { const section = document.getElementById('weight-progress-section'); const arrow = document.getElementById('chart-arrow'); section.classList.toggle('open'); arrow.style.transform = section.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; if (section.classList.contains('open')) renderWeightChart(); }
        window.renderWeightChart = function() { const container = document.getElementById('weight-chart'); const datesContainer = document.getElementById('weight-chart-dates'); if (userProfile.weightHistory.length < 2) { container.innerHTML = '<div class="w-full text-center text-xs opacity-50 pb-4">–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∑–∞–º–µ—Ä–∞</div>'; return; } const weights = userProfile.weightHistory.map(x => x.weight); const minW = Math.min(...weights) - 2; const maxW = Math.max(...weights) + 2; const range = maxW - minW; container.innerHTML = userProfile.weightHistory.map(entry => { const heightPct = ((entry.weight - minW) / range) * 80 + 20; return `<div class="chart-bar" style="height: ${heightPct}%"><span class="chart-label">${entry.weight}</span></div>`; }).join(''); datesContainer.innerHTML = userProfile.weightHistory.map(entry => `<div style="flex:1" class="chart-date">${entry.date}</div>`).join(''); }
        window.selectGender = function(gender) { if (userProfile.isLocked && gender !== userProfile.gender) return; userProfile.gender = gender; const btnMale = document.getElementById('gender-male'); const btnFemale = document.getElementById('gender-female'); if (gender === 'male') { btnMale.className = "flex-1 py-2 rounded-lg text-sm font-bold transition-all bg-white text-blue-600 shadow-sm"; btnFemale.className = "flex-1 py-2 rounded-lg text-sm font-bold transition-all text-gray-400"; } else { btnMale.className = "flex-1 py-2 rounded-lg text-sm font-bold transition-all text-gray-400"; btnFemale.className = "flex-1 py-2 rounded-lg text-sm font-bold transition-all bg-white text-pink-600 shadow-sm"; } persistData(); }
        window.calculateBMI = function() { const h = parseFloat(document.getElementById('profile-height').value); const w = parseFloat(document.getElementById('profile-weight').value); const display = document.getElementById('bmi-display'); if (h > 0 && w > 0) { const bmi = w / ((h / 100) ** 2); display.innerText = bmi.toFixed(1); } else { display.innerText = "--.--"; } }
        window.handleProfileButton = function() { if (!userProfile.isLocked) saveAndLockProfile(); else switchTab('workout'); }
        window.saveAndLockProfile = function() { syncProfileData(); if (!userProfile.name || !userProfile.weight || !userProfile.height || !userProfile.age) { tg.HapticFeedback.notificationOccurred('error'); alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!"); return; } userProfile.isLocked = true; ['profile-name', 'profile-age', 'profile-height'].forEach(id => { document.getElementById(id).disabled = true; document.getElementById(id).classList.add('opacity-50'); }); document.getElementById('btn-save-profile').innerText = "–ö –¢–†–ï–ù–ò–†–û–í–ö–ï"; saveCurrentWeight(); persistData(); tg.HapticFeedback.notificationOccurred('success'); switchTab('workout'); }

        window.switchTab = function(tabName) {
            ['profile', 'workout', 'history'].forEach(t => { document.getElementById(`tab-${t}`).classList.add('hidden-view'); document.getElementById(`nav-${t}`).classList.remove('active'); });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden-view');
            document.getElementById(`nav-${tabName}`).classList.add('active');
            if (tabName === 'profile' && document.getElementById('weight-progress-section').classList.contains('open')) renderWeightChart();
            if (tabName === 'history') renderHistoryList();
            window.scrollTo({ top: 0 });
        }

        window.setWorkoutType = function(type) {
            document.getElementById('type-strength').classList.remove('border-blue-500', 'bg-blue-50');
            document.getElementById('type-cardio').classList.remove('border-blue-500', 'bg-blue-50');
            document.getElementById('focus-area-strength').classList.add('hidden');
            document.getElementById('focus-area-cardio').classList.add('hidden');
            if (type === 'strength') { document.getElementById('type-strength').classList.add('border-blue-500', 'bg-blue-50'); document.getElementById('focus-area-strength').classList.remove('hidden'); }
            else { document.getElementById('type-cardio').classList.add('border-blue-500', 'bg-blue-50'); document.getElementById('focus-area-cardio').classList.remove('hidden'); }
        }

        window.startCustomWorkout = function() {
            currentProgram = [];
            currentWorkoutTitle = "–°–≤–æ—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
            workoutLogs = {};
            renderProgramList(currentWorkoutTitle);
            document.getElementById('view-selector').classList.add('hidden');
            document.getElementById('view-plan').classList.remove('hidden-view');
            setTimeout(openAddExerciseModal, 300);
        }

        window.generateAIProgram = async function(focus) {
            const loader = document.getElementById('ai-loading');
            document.getElementById('loading-text').innerText = `–°–æ—Å—Ç–∞–≤–ª—è—é –ø–ª–∞–Ω –Ω–∞: ${focus}...`;
            loader.style.display = 'flex';
            currentWorkoutTitle = `–°–∏–ª–æ–≤–∞—è: ${focus}`;
            if(focus === 'HIIT' || focus === 'LISS') currentWorkoutTitle = `–ö–∞—Ä–¥–∏–æ: ${focus}`;
            const genderStr = userProfile.gender === 'male' ? "–ú—É–∂—á–∏–Ω–∞" : "–ñ–µ–Ω—â–∏–Ω–∞";
            const w = userProfile.weight || "70"; 
            const prompt = `–°–æ–∑–¥–∞–π –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ê—Ç–ª–µ—Ç: ${genderStr}, –≤–µ—Å ${w}–∫–≥, —Ü–µ–ª—å: ${focus}. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON (–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤). –§–æ—Ä–º–∞—Ç: [{"name": "–ù–∞–∑–≤–∞–Ω–∏–µ", "sets": 3, "reps": "10-12", "tip": "–°–æ–≤–µ—Ç", "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"}] –ú–∞–∫—Å 5-6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.`;
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const result = await response.json();
                let text = result.candidates?.[0]?.content?.parts?.[0]?.text || "[]";
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                currentProgram = JSON.parse(text);
                workoutLogs = {};
                renderProgramList(currentWorkoutTitle);
                document.getElementById('view-selector').classList.add('hidden');
                document.getElementById('view-plan').classList.remove('hidden-view');
            } catch (e) { alert("–û—à–∏–±–∫–∞ –ò–ò. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑."); } finally { loader.style.display = 'none'; }
        }

        window.renderProgramList = function(title) {
            document.getElementById('plan-title').innerText = `${title}`;
            const list = document.getElementById('program-list');
            if (currentProgram.length === 0) {
                 list.innerHTML = `<div class="text-center py-10 opacity-50 text-sm">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç.<br>–î–æ–±–∞–≤—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</div><button onclick="openAddExerciseModal()" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold flex items-center justify-center gap-2 active:bg-gray-50"><i data-lucide="plus" class="w-5 h-5"></i> –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>`;
            } else {
                let html = currentProgram.map((ex, index) => {
                    const isDone = workoutLogs[ex.name] && workoutLogs[ex.name].length >= ex.sets;
                    return `<div class="program-item ${isDone ? 'completed' : 'bg-white'} card flex items-stretch shadow-sm relative overflow-hidden group"><div onclick="showExerciseInfo(${index})" class="flex-1 p-4 active:bg-gray-50 transition-colors cursor-pointer"><h4 class="font-bold text-md ${isDone ? 'line-through opacity-50' : ''}">${ex.name}</h4><p class="text-xs text-gray-500">${ex.sets} x ${ex.reps}</p></div><div class="flex items-center px-2 bg-gray-50/50 border-l border-gray-100 gap-1"><button onclick="showExerciseInfo(${index})" class="p-2 rounded-full text-blue-400 hover:bg-blue-100 transition-colors"><i data-lucide="info" class="w-5 h-5"></i></button>${!isDone ? `<button onclick="replaceExercise(${index})" class="p-2 rounded-full text-gray-400 hover:bg-gray-200 transition-colors"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>` : ''}<div class="p-2"><i data-lucide="${isDone ? 'check-circle' : 'chevron-right'}" class="w-5 h-5 ${isDone ? 'text-green-500' : 'text-gray-300'}"></i></div></div></div>`;
                }).join('');
                
                const hasLogs = Object.keys(workoutLogs).length > 0;
                html += `<div class="flex flex-col gap-3 mt-6 mb-8"><button onclick="openAddExerciseModal()" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold flex items-center justify-center gap-2 active:bg-gray-50"><i data-lucide="plus" class="w-5 h-5"></i> –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>${hasLogs ? `<button onclick="finishWorkout()" class="w-full bg-green-500 text-white px-4 py-4 rounded-2xl font-black text-xl shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-transform"><i data-lucide="flag" class="w-6 h-6"></i> –ó–ê–í–ï–†–®–ò–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£</button>` : `<button onclick="startWorkoutRoutine()" class="btn-primary w-full py-4 rounded-2xl font-black text-xl shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-transform border-b-4 border-blue-700"><i data-lucide="play" class="w-6 h-6 fill-current"></i> –°–¢–ê–†–¢ –¢–†–ï–ù–ò–†–û–í–ö–ò</button>`}</div>`;
                list.innerHTML = html;
            }
            lucide.createIcons();
        }

        window.startWorkoutRoutine = function() {
            try {
                if (currentProgram.length === 0) { alert("–î–æ–±–∞–≤—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è!"); return; }
                isWorkoutActive = true;
                workoutLogs = {}; 
                loadActiveExercise(0);
                document.getElementById('view-plan').classList.add('hidden-view');
                document.getElementById('view-active-workout').classList.remove('hidden-view');
            } catch (e) { console.error(e); alert("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏."); }
        }

        function loadActiveExercise(index) {
            if (index >= currentProgram.length) { finishWorkout(); return; }
            currentExerciseIndex = index;
            const ex = currentProgram[index];
            if(!ex) return;
            document.getElementById('active-progress').innerText = `${index + 1} –∏–∑ ${currentProgram.length}`;
            document.getElementById('active-ex-name').innerText = ex.name;
            document.getElementById('active-ex-tip').innerText = ex.tip || "–°–æ–±–ª—é–¥–∞–π —Ç–µ—Ö–Ω–∏–∫—É";
            document.getElementById('active-weight').value = "";
            document.getElementById('active-reps').value = "";
            updateSetsIndicator();
        }

        function updateSetsIndicator() {
            const ex = currentProgram[currentExerciseIndex];
            if(!ex) return;
            const exName = ex.name;
            const logs = workoutLogs[exName] || [];
            const target = ex.sets || 3;
            const container = document.getElementById('sets-dots');
            let html = '';
            for(let i = 0; i < target; i++) {
                if (i < logs.length) html += `<div class="w-3 h-3 rounded-full bg-blue-500"></div>`;
                else html += `<div class="w-3 h-3 rounded-full bg-gray-200"></div>`;
            }
            if (logs.length >= target) html += `<div class="w-3 h-3 rounded-full bg-green-500 animate-pulse text-[10px] flex items-center justify-center text-white font-bold">+</div>`;
            container.innerHTML = html;
            
            const btn = document.querySelector('#active-actions button');
            if (logs.length >= target) {
                const isLastExercise = currentExerciseIndex >= currentProgram.length - 1;
                if (isLastExercise) {
                    btn.innerHTML = `<i data-lucide="flag" class="w-6 h-6"></i> –ó–ê–í–ï–†–®–ò–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£`;
                    btn.className = "w-full py-4 rounded-xl font-black text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform bg-gradient-to-r from-green-500 to-emerald-600 text-white";
                    btn.onclick = () => finishWorkout(true); 
                } else {
                    btn.innerHTML = `<i data-lucide="arrow-right-circle" class="w-6 h-6"></i> –°–õ–ï–î–£–Æ–©–ï–ï –£–ü–†–ê–ñ–ù–ï–ù–ò–ï`;
                    btn.className = "btn-primary w-full py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform shadow-lg flex items-center justify-center gap-2 bg-green-600 text-white";
                    btn.onclick = nextExercise;
                }
                
                if(!document.getElementById('btn-extra-set')) {
                    const extraBtn = document.createElement('button');
                    extraBtn.id = 'btn-extra-set';
                    extraBtn.className = "w-full py-3 text-sm font-bold text-gray-400 mt-2";
                    extraBtn.innerText = "–°–¥–µ–ª–∞—Ç—å –µ—â–µ –ø–æ–¥—Ö–æ–¥";
                    extraBtn.onclick = () => {
                        btn.innerHTML = `<i data-lucide="check" class="w-6 h-6"></i> –ó–ê–ü–ò–°–ê–¢–¨ –ü–û–î–•–û–î`;
                        btn.className = "btn-primary w-full py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform shadow-lg flex items-center justify-center gap-2";
                        btn.onclick = logActiveSet;
                        btn.classList.remove('bg-green-600', 'bg-gradient-to-r', 'from-green-500', 'to-emerald-600', 'text-white');
                        btn.classList.add('bg-blue-600', 'text-white');
                        extraBtn.remove();
                        lucide.createIcons();
                    };
                    document.getElementById('active-actions').appendChild(extraBtn);
                }
            } else {
                btn.innerHTML = `<i data-lucide="check" class="w-6 h-6"></i> –ó–ê–ü–ò–°–ê–¢–¨ –ü–û–î–•–û–î`;
                btn.className = "btn-primary w-full py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform shadow-lg flex items-center justify-center gap-2";
                btn.classList.remove('bg-green-600');
                btn.onclick = logActiveSet;
                const extra = document.getElementById('btn-extra-set');
                if(extra) extra.remove();
            }
            lucide.createIcons();
        }

        window.logActiveSet = function() {
            const weight = parseFloat(document.getElementById('active-weight').value);
            const reps = parseInt(document.getElementById('active-reps').value);
            if (!weight || !reps) { tg.HapticFeedback.notificationOccurred('error'); return; }
            const exName = currentProgram[currentExerciseIndex].name;
            if (!workoutLogs[exName]) workoutLogs[exName] = [];
            workoutLogs[exName].push({ weight, reps, timestamp: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
            tg.HapticFeedback.notificationOccurred('success');
            const target = currentProgram[currentExerciseIndex].sets || 3;
            const isLastExercise = currentExerciseIndex >= currentProgram.length - 1;
            const isFinishedPlan = workoutLogs[exName].length >= target;
            if (isFinishedPlan) { updateSetsIndicator(); } 
            if (isFinishedPlan && isLastExercise) { } else { startRestTimer(); }
        }

        let timerInterval;
        function startRestTimer() {
            const modal = document.getElementById('modal-rest');
            const timerDisplay = document.getElementById('rest-timer-big');
            const nextStep = document.getElementById('rest-next-step');
            const nextEx = document.getElementById('rest-next-ex');
            const exName = currentProgram[currentExerciseIndex].name;
            const currentSets = workoutLogs[exName]?.length || 0;
            const target = currentProgram[currentExerciseIndex].sets || 3;
            modal.classList.remove('hidden-view');
            if (currentSets >= target) {
                nextStep.innerText = "–°–ª–µ–¥—É—é—â–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ";
                const nextProgramEx = currentProgram[currentExerciseIndex + 1];
                nextEx.innerText = nextProgramEx ? nextProgramEx.name : "–§–∏–Ω–∏—à!";
            } else { nextStep.innerText = `–ü–æ–¥—Ö–æ–¥ ${currentSets + 1}`; nextEx.innerText = exName; }
            let timeLeft = 90; 
            clearInterval(timerInterval);
            const update = () => {
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                timerDisplay.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if(timeLeft <= 0) { clearInterval(timerInterval); tg.HapticFeedback.notificationOccurred('warning'); skipRest(); }
                timeLeft--;
            };
            update();
            timerInterval = setInterval(update, 1000);
        }

        window.skipRest = function() { clearInterval(timerInterval); document.getElementById('modal-rest').classList.add('hidden-view'); updateSetsIndicator(); }
        window.nextExercise = function() { loadActiveExercise(currentExerciseIndex + 1); }
        window.skipCurrentExercise = function() { if(confirm("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ?")) { nextExercise(); } }

        window.finishWorkout = function(skipConfirm = false) {
            if (!skipConfirm && !confirm("–ó–∞–∫–æ–Ω—á–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é?")) return;
            document.getElementById('modal-workout-summary').classList.remove('hidden-view');
            let totalSets = 0;
            let totalExercises = Object.keys(workoutLogs).length;
            Object.values(workoutLogs).forEach(sets => totalSets += sets.length);
            document.getElementById('summary-total-exercises').innerText = totalExercises;
            document.getElementById('summary-total-sets').innerText = totalSets;
            generatePostWorkoutAnalysis(totalExercises, totalSets);
        }

        async function generatePostWorkoutAnalysis(exCount, setCount) {
            const prompt = `–Ø —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–∫–æ–Ω—á–∏–ª —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É: "${currentWorkoutTitle}". –°–¥–µ–ª–∞–ª ${exCount} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏ ${setCount} –ø–æ–¥—Ö–æ–¥–æ–≤. –ö—Ä–∞—Ç–∫–æ –ø–æ—Ö–≤–∞–ª–∏ –∏ –¥–∞–π –û–î–ò–ù –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–æ–≤–µ—Ç –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–≥–æ, —á—Ç–æ —ç—Ç–æ ${currentWorkoutTitle}).`;
            const container = document.getElementById('summary-ai-content');
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –ü–æ–µ—à—å –∏ –æ—Ç–¥–æ—Ö–Ω–∏.";
                container.innerText = text;
            } catch (e) { container.innerText = "–¢—Ä–µ–Ω–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ —Ç—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –º–æ–ª–æ–¥–µ—Ü!"; }
        }

        window.closeSummaryAndSave = function() {
            document.getElementById('modal-workout-summary').classList.add('hidden-view');
            const sessionData = { id: Date.now(), date: new Date().toLocaleDateString('ru-RU'), title: currentWorkoutTitle, logs: JSON.parse(JSON.stringify(workoutLogs)), program: JSON.parse(JSON.stringify(currentProgram)) };
            userProfile.workoutHistory.push(sessionData);
            persistData();
            tg.HapticFeedback.notificationOccurred('success');
            currentProgram = [];
            workoutLogs = {};
            isWorkoutActive = false;
            document.getElementById('view-active-workout').classList.add('hidden-view');
            backToSelector(); 
            switchTab('history');
        }

        window.renderHistoryList = function() {
            const list = document.getElementById('history-list');
            if (userProfile.workoutHistory.length === 0) { list.innerHTML = `<div class="text-center py-10 opacity-40 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>`; return; }
            list.innerHTML = [...userProfile.workoutHistory].reverse().map(session => {
                let totalSets = 0; let totalExercises = Object.keys(session.logs).length;
                Object.values(session.logs).forEach(sets => totalSets += sets.length);
                return `<div onclick="openHistoryDetail(${session.id})" class="card p-4 flex justify-between items-center active:scale-[0.98] transition-transform"><div><div class="text-[10px] font-bold opacity-50 uppercase mb-1">${session.date}</div><h3 class="font-bold text-md">${session.title}</h3><div class="text-xs text-gray-500 mt-1">${totalExercises} —É–ø—Ä. ‚Ä¢ ${totalSets} –ø–æ–¥—Ö–æ–¥–æ–≤</div></div><i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i></div>`;
            }).join('');
            lucide.createIcons();
        }

        window.openHistoryDetail = function(id) {
            const session = userProfile.workoutHistory.find(s => s.id === id);
            if (!session) return;
            document.getElementById('hist-detail-title').innerText = session.title;
            document.getElementById('hist-detail-date').innerText = session.date;
            const content = document.getElementById('hist-detail-content');
            if (Object.keys(session.logs).length === 0) { content.innerHTML = `<div class="text-center text-sm opacity-50">–ü—É—Å—Ç–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>`; } else {
                content.innerHTML = Object.entries(session.logs).map(([name, sets]) => `<div class="bg-white p-4 rounded-xl border border-gray-100"><h4 class="font-bold text-sm mb-2 text-blue-900">${name}</h4><div class="space-y-1">${sets.map((set, i) => `<div class="flex justify-between text-xs border-b border-gray-50 pb-1 last:border-0"><span class="opacity-50">#${i+1}</span><span class="font-bold">${set.weight} –∫–≥ √ó ${set.reps}</span></div>`).join('')}</div></div>`).join('');
            }
            document.getElementById('modal-history-detail').classList.remove('hidden-view');
        }

        window.closeHistoryDetail = function() { document.getElementById('modal-history-detail').classList.add('hidden-view'); }
        window.analyzeHistory = async function() {
            if (userProfile.workoutHistory.length === 0) { alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ—Ç—Ä–µ–Ω–∏—Ä—É–π—Å—è!"); return; }
            const loader = document.getElementById('ai-loading');
            document.getElementById('loading-text').innerText = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø—Ä–æ–≥—Ä–µ—Å—Å...";
            loader.style.display = 'flex';
            const recent = userProfile.workoutHistory.slice(-5);
            const dataStr = JSON.stringify(recent.map(s => ({ date: s.date, title: s.title, stats: s.logs })));
            const prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: ${dataStr}. –û—Ç–≤–µ—Ç—å –∫–∞–∫ —Ç—Ä–µ–Ω–µ—Ä. –¢—Ä–µ–Ω–¥—ã? –ü—Ä–æ–≥—Ä–µ—Å—Å –≤ –≤–µ—Å–∞—Ö? –ß—Ç–æ —è –ø—Ä–æ–ø—É—Å–∫–∞—é? –î–∞–π —Å–æ–≤–µ—Ç. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º (–º–∞–∫—Å 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º.`;
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.";
                document.getElementById('history-ai-text').innerText = text;
                document.getElementById('history-ai-result').classList.remove('hidden');
            } catch (e) { alert("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞."); } finally { loader.style.display = 'none'; }
        }
        window.closeHistoryAi = function() { document.getElementById('history-ai-result').classList.add('hidden'); }
        window.replaceExercise = function(index) { replacementIndex = index; const ex = currentProgram[index]; document.getElementById('modal-add-exercise').classList.remove('hidden-view'); document.getElementById('modal-add-title').innerText = `–ó–∞–º–µ–Ω–∞: "${ex.name}"`; document.getElementById('search-exercise').value = ""; document.getElementById('btn-add-text').innerText = "–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ..."; document.getElementById('manual-inputs').classList.add('hidden'); document.getElementById('btn-add-manual').classList.add('opacity-50', 'pointer-events-none'); document.getElementById('ai-suggestions-container').classList.add('hidden'); document.getElementById('btn-ask-ai').classList.remove('hidden'); setAddTab('strength'); document.getElementById('search-exercise').focus(); }
        window.triggerAiSuggestions = function() { if (replacementIndex === null) return; const ex = currentProgram[replacementIndex]; document.getElementById('btn-ask-ai').classList.add('hidden'); const aiContainer = document.getElementById('ai-suggestions-container'); const aiList = document.getElementById('ai-suggestions-list'); aiContainer.classList.remove('hidden'); aiList.innerHTML = `<div class="flex flex-col items-center justify-center py-6 gap-3"><div class="loader border-purple-200 border-t-purple-600"></div><span class="text-xs text-purple-600 font-bold animate-pulse text-center">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –±–∏–æ–º–µ—Ö–∞–Ω–∏–∫—É...</span></div>`; generateAiReplacements(ex.name); }
        window.hideAiSuggestions = function() { document.getElementById('ai-suggestions-container').classList.add('hidden'); document.getElementById('btn-ask-ai').classList.remove('hidden'); }
        window.generateAiReplacements = async function(exerciseName) { const prompt = `–ó–∞–º–µ–Ω–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${exerciseName}". –ü—Ä–µ–¥–ª–æ–∂–∏ 3 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã. JSON: [{"name": "–ù–∞–∑–≤–∞–Ω–∏–µ", "reason": "–ü–æ—á–µ–º—É", "description_short": "–¢–µ—Ö–Ω–∏–∫–∞", "sets": 3, "reps": "10-12", "tip": "–°–æ–≤–µ—Ç"}]`; try { const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); const result = await response.json(); let text = result.candidates?.[0]?.content?.parts?.[0]?.text || "[]"; text = text.replace(/```json/g, '').replace(/```/g, '').trim(); renderAiSuggestions(JSON.parse(text)); } catch (e) { document.getElementById('ai-suggestions-list').innerHTML = `<div class="text-xs text-red-400 text-center py-2">–û—à–∏–±–∫–∞.</div>`; } }
        window.renderAiSuggestions = function(suggestions) { const list = document.getElementById('ai-suggestions-list'); if (suggestions.length === 0) { list.innerHTML = `<div class="text-xs text-gray-400 text-center">–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>`; return; } list.innerHTML = suggestions.map((s) => { const sString = JSON.stringify(s).replace(/"/g, '&quot;'); return `<div onclick="applyReplacement(${sString})" class="ai-suggestion-card p-3 rounded-xl active:scale-[0.98] transition-transform cursor-pointer shadow-sm bg-white border border-purple-100 hover:border-purple-300"><div class="flex justify-between items-start mb-1"><span class="font-bold text-sm text-purple-900">${s.name}</span><div class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded text-[10px] font-bold">–í—ã–±—Ä–∞—Ç—å</div></div><div class="text-[10px] text-gray-500 mb-1 leading-tight"><span class="font-bold text-purple-700">–ó–∞—á–µ–º:</span> ${s.reason}</div><div class="text-[10px] text-gray-600 italic leading-tight border-t border-purple-50 pt-1 mt-1">${s.description_short || "–¢–µ—Ö–Ω–∏–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è."}</div></div>` }).join(''); lucide.createIcons(); }
        window.applyReplacement = function(newEx) { if (replacementIndex !== null) { currentProgram[replacementIndex] = newEx; replacementIndex = null; closeAddExerciseModal(); renderProgramList(document.getElementById('plan-title').innerText); tg.HapticFeedback.notificationOccurred('success'); } }
        window.showExerciseInfo = function(index) { const ex = currentProgram[index]; document.getElementById('info-title').innerText = ex.name; document.getElementById('info-description').innerText = ex.description || ex.tip || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."; document.getElementById('modal-info').classList.remove('hidden-view'); }
        window.closeInfoModal = function() { document.getElementById('modal-info').classList.add('hidden-view'); }
        window.backToSelector = function() { document.getElementById('view-plan').classList.add('hidden-view'); document.getElementById('view-selector').classList.remove('hidden'); }
        window.openAddExerciseModal = function() { replacementIndex = null; document.getElementById('ai-suggestions-container').classList.add('hidden'); document.getElementById('btn-ask-ai').classList.add('hidden'); document.getElementById('modal-add-exercise').classList.remove('hidden-view'); document.getElementById('modal-add-title').innerText = "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"; document.getElementById('search-exercise').value = ""; setAddTab('strength'); document.getElementById('search-exercise').focus(); }
        window.closeAddExerciseModal = function() { document.getElementById('modal-add-exercise').classList.add('hidden-view'); }
        window.setAddTab = function(type) { addModalType = type; const btnS = document.getElementById('tab-add-strength'); const btnC = document.getElementById('tab-add-cardio'); if (type === 'strength') { btnS.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm"; btnC.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all text-gray-400"; } else { btnS.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all text-gray-400"; btnC.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm"; } filterExercises(); }
        window.filterExercises = function() { const query = document.getElementById('search-exercise').value.toLowerCase(); const list = EXERCISE_DB[addModalType]; const container = document.getElementById('exercise-search-results'); const filtered = list.filter(ex => ex.toLowerCase().includes(query)); const btnText = document.getElementById('btn-add-text'); const btnManual = document.getElementById('btn-add-manual'); const inputsManual = document.getElementById('manual-inputs'); if (query.length > 0) { btnText.innerText = `–î–æ–±–∞–≤–∏—Ç—å "${document.getElementById('search-exercise').value}"`; btnManual.classList.remove('opacity-50', 'pointer-events-none'); inputsManual.classList.remove('hidden'); } else { btnText.innerText = "–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã—à–µ..."; btnManual.classList.add('opacity-50', 'pointer-events-none'); inputsManual.classList.add('hidden'); } const icon = replacementIndex !== null ? 'refresh-cw' : 'plus-circle'; container.innerHTML = filtered.map(ex => `<div onclick="addExerciseDirectly('${ex}')" class="search-item p-3 border-b border-gray-50 flex justify-between items-center active:bg-gray-50"><span class="font-bold text-sm">${ex}</span><i data-lucide="${icon}" class="w-4 h-4 text-blue-500"></i></div>`).join(''); lucide.createIcons(); }
        window.addExerciseDirectly = function(name) { const isCardio = addModalType === 'cardio'; const newEx = { name: name, sets: isCardio ? 1 : 3, reps: isCardio ? "20 –º–∏–Ω" : "12", tip: "–¢–µ—Ö–Ω–∏–∫–∞ –≤–∞–∂–Ω–∞!", description: "–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é." }; if (replacementIndex !== null) { currentProgram[replacementIndex] = newEx; replacementIndex = null; } else { currentProgram.push(newEx); } closeAddExerciseModal(); renderProgramList(document.getElementById('plan-title').innerText); tg.HapticFeedback.notificationOccurred('success'); }
        window.addExerciseFromInput = function() { const name = document.getElementById('search-exercise').value; if(!name) return; const sets = document.getElementById('manual-sets').value; const reps = document.getElementById('manual-reps').value; const newEx = { name: name, sets: parseInt(sets) || 3, reps: reps || "12", tip: "–°–æ–±–ª—é–¥–∞–π —Ç–µ—Ö–Ω–∏–∫—É", description: "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é" }; if (replacementIndex !== null) { currentProgram[replacementIndex] = newEx; replacementIndex = null; } else { currentProgram.push(newEx); } closeAddExerciseModal(); renderProgramList(document.getElementById('plan-title').innerText); tg.HapticFeedback.notificationOccurred('success'); }
        window.getAiProTip = async function() { const ex = currentProgram[currentExerciseIndex]; const tipEl = document.getElementById('active-ex-tip'); tipEl.innerHTML = `<span class="animate-pulse text-purple-600">–°–ø—Ä–∞—à–∏–≤–∞—é —É —Ç—Ä–µ–Ω–µ—Ä–∞...</span>`; const prompt = `–î–∞–π –û–î–ò–ù –∫–æ—Ä–æ—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç –ø–æ –±–∏–æ–º–µ—Ö–∞–Ω–∏–∫–µ (–ª–∞–π—Ñ—Ö–∞–∫) –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è "${ex.name}", —á—Ç–æ–±—ã –ª—É—á—à–µ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Ü–µ–ª–µ–≤—É—é –º—ã—à—Ü—É. –ú–∞–∫—Å–∏–º—É–º 10-12 —Å–ª–æ–≤.`; try { const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); const result = await response.json(); const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ –º—ã—à—Ü."; tipEl.innerText = "üí° " + text; tipEl.classList.add("bg-purple-50", "text-purple-800", "border", "border-purple-200"); } catch (e) { tipEl.innerText = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º."; } }
        window.closeActiveMode = function() { document.getElementById('view-active-workout').classList.add('hidden-view'); renderProgramList(document.getElementById('plan-title').innerText); document.getElementById('view-plan').classList.remove('hidden-view'); }

        tg.onEvent('themeChanged', () => {
            document.body.style.backgroundColor = tg.themeParams.bg_color;
            document.body.style.color = tg.themeParams.text_color;
        });
    </script>
</body>
</html>
